---
author: XiongChaoJie
pubDatetime: 2025-01-09T10:58:53Z
title: ä½¿ç”¨ React + MapBox ç”Ÿæˆ GPS è½¨è¿¹è§†é¢‘
slug: react-mapbox-track-route-video
featured: false
draft: true
tags:
  - Admob
  - advertisement
description: ä½¿ç”¨ React + MapBoxï¼Œå®ç°ä» GoPro è§†é¢‘ä¸­æå– GPX è½¨è¿¹æ–‡ä»¶ï¼Œå¹¶ç”Ÿæˆ GPS è½¨è¿¹è§†é¢‘ã€‚
---

# èƒŒæ™¯

æœ€è¿‘æƒ³åœ¨ä¹‹å‰æ‹æ‘„çš„ç¬¬ä¸€è§†è§’è¡Œè½¦è§†é¢‘ä¸­æ·»åŠ  GPS åœ°å›¾è½¨è¿¹ï¼Œä»¥ä¾¿æ›´å¥½åœ°å±•ç¤ºè¡Œç¨‹è·¯çº¿ã€‚åœ¨ç½‘ä¸Šæœç´¢äº†ä¸€åœˆä¹‹åï¼Œå¹¶æ²¡æœ‰ç°æœ‰çš„å·¥å…·å¯ä»¥æ»¡è¶³æˆ‘çš„éœ€æ±‚ã€‚

ç°æœ‰çš„å¤§å¤šæ•°å·¥å…·è™½ç„¶èƒ½ç”Ÿæˆè½¨è¿¹è§†é¢‘ï¼Œä½†å¤§å¤šæ•°åªèƒ½ç”Ÿæˆå›ºå®šæ—¶é•¿çš„å€é€Ÿè§†é¢‘ï¼Œå¹¶æ²¡æœ‰èƒ½å¤Ÿæ ¹æ®è§†é¢‘çš„å®é™…è¡Œç¨‹å®æ—¶ç”Ÿæˆè½¨è¿¹çš„å·¥å…·ã€‚

åœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œæˆ‘å°†é€šè¿‡ **React** å’Œ **Mapbox.js** å®ç°ä¸€ä¸ªåŠŸèƒ½ï¼šå°† GPX æ–‡ä»¶ä¸­çš„è½¨è¿¹æ¸²æŸ“åˆ°åœ°å›¾ä¸Šï¼Œå¹¶ç”ŸæˆåŠ¨æ€è½¨è¿¹è§†é¢‘ã€‚å¯ä»¥ç”¨äºè®°å½•è·‘æ­¥ã€éª‘è¡Œç­‰æ´»åŠ¨çš„è½¨è¿¹ï¼Œå¹¶ä»¥è§†é¢‘çš„å½¢å¼å±•ç¤ºã€‚

![](@/assets/images/mapbox1.png)

## 1. é¡¹ç›®èƒŒæ™¯

GPXï¼ˆGPS eXchange Formatï¼‰æ˜¯ä¸€ç§å¸¸è§çš„ GPS æ•°æ®æ–‡ä»¶æ ¼å¼ï¼Œç”¨äºå­˜å‚¨ä½ç½®ä¿¡æ¯ï¼Œå¦‚ç»çº¬åº¦ã€æ—¶é—´æˆ³ç­‰ã€‚é€šè¿‡ GPX æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åœ°å›¾ä¸Šå±•ç¤ºè½¨è¿¹ï¼Œå¹¶ä¸”é€šè¿‡åŠ¨æ€åŠ¨ç”»æ¨¡æ‹Ÿå‡ºè½¨è¿¹çš„ç”Ÿæˆè¿‡ç¨‹ã€‚

åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å°†ï¼š

- ä½¿ç”¨ **Mapbox.js** æ¸²æŸ“ GPX è½¨è¿¹ã€‚
- ä½¿ç”¨ **React** æ„å»ºç”¨æˆ·ç•Œé¢ã€‚
- åˆ©ç”¨ **FFmpeg** å°†è½¨è¿¹ç”Ÿæˆçš„è§†é¢‘å¯¼å‡ºã€‚

æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š

1. åœ°å›¾ä¸ŠåŠ¨æ€ç»˜åˆ¶ GPX è½¨è¿¹ã€‚
2. å°†åœ°å›¾è½¨è¿¹ç»˜åˆ¶è¿‡ç¨‹å½•åˆ¶å¹¶å¯¼å‡ºä¸º MP4 è§†é¢‘ã€‚

## 2. æŠ€æœ¯æ ˆä¸å·¥å…·

- **React**: å‰ç«¯æ¡†æ¶ï¼Œç”¨äºæ„å»ºç”¨æˆ·ç•Œé¢ã€‚
- **Mapbox.js**: åœ°å›¾æ¸²æŸ“åº“ï¼Œç”¨äºåœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºè½¨è¿¹ã€‚
- **FFmpeg**: éŸ³è§†é¢‘å¤„ç†å·¥å…·ï¼Œç”¨äºå°†æˆªå›¾åˆæˆä¸ºè§†é¢‘ã€‚
- **Vite**: æ„å»ºå·¥å…·ï¼Œæä¾›å¿«é€Ÿå¼€å‘ä½“éªŒã€‚

## 3. å®ç°æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–é¡¹ç›®

1. **åˆ›å»º React é¡¹ç›®**

```bash
npm create vite@latest gpx-to-video --template react
cd gpx-to-video
npm install
```

2. **å®‰è£…ä¾èµ–**

- å®‰è£… Mapbox.js

```bash
npm install mapbox-gl
```

- å®‰è£… FFmpeg

```bash
npm install @ffmpeg/ffmpeg @ffmpeg/util
```

### ç¬¬äºŒæ­¥ï¼šåŠ è½½ GPX æ•°æ®å¹¶æ¸²æŸ“åœ°å›¾

#### 1. é…ç½® Mapbox.js

åˆ›å»º `MapComponent.jsx`ï¼Œåˆå§‹åŒ–åœ°å›¾å¹¶åŠ è½½ GPX æ•°æ®ã€‚

```jsx
import React, { useRef, useEffect, useState } from "react";
import mapboxgl from "mapbox-gl";
import "mapbox-gl/dist/mapbox-gl.css";
import { gpx } from "@tmcw/togeojson";

mapboxgl.accessToken = "YOUR_MAPBOX_ACCESS_TOKEN";

const MapComponent = ({ gpxFile }) => {
  const mapContainerRef = useRef(null);
  const mapRef = useRef(null);

  const [geojson, setGeojson] = useState(null);

  useEffect(() => {
    // åˆå§‹åŒ–åœ°å›¾
    mapRef.current = new mapboxgl.Map({
      container: mapContainerRef.current,
      style: "mapbox://styles/mapbox/streets-v11",
      center: [0, 0], // é»˜è®¤ä¸­å¿ƒç‚¹
      zoom: 12,
    });

    return () => {
      mapRef.current?.remove();
    };
  }, []);

  useEffect(() => {
    if (!gpxFile) return;

    // è§£æ GPX æ–‡ä»¶
    const reader = new FileReader();
    reader.onload = e => {
      const parser = new DOMParser();
      const gpxDoc = parser.parseFromString(e.target.result, "application/xml");
      const geojsonData = gpx(gpxDoc);

      // åŠ è½½è½¨è¿¹åˆ°åœ°å›¾
      mapRef.current?.addSource("track", {
        type: "geojson",
        data: geojsonData,
      });

      mapRef.current?.addLayer({
        id: "track-layer",
        type: "line",
        source: "track",
        paint: {
          "line-color": "#ff0000",
          "line-width": 4,
        },
      });

      setGeojson(geojsonData);
    };

    reader.readAsText(gpxFile);
  }, [gpxFile]);

  return (
    <div ref={mapContainerRef} style={{ height: "500px", width: "100%" }} />
  );
};

export default MapComponent;
```

---

### ç¬¬ä¸‰æ­¥ï¼šå®ç°è½¨è¿¹åŠ¨æ€ç»˜åˆ¶

æ·»åŠ åŠ¨æ€è½¨è¿¹åŠ¨ç”»ã€‚

```jsx
const animateTrack = geojson => {
  let coordinates = geojson.features[0].geometry.coordinates;
  let index = 0;

  const animate = () => {
    if (index < coordinates.length) {
      const partialTrack = {
        type: "Feature",
        geometry: {
          type: "LineString",
          coordinates: coordinates.slice(0, index + 1),
        },
      };

      mapRef.current.getSource("track").setData(partialTrack);
      index++;

      requestAnimationFrame(animate);
    }
  };

  animate();
};
```

---

### ç¬¬å››æ­¥ï¼šç”Ÿæˆè§†é¢‘

åˆ©ç”¨ FFmpeg å°†åŠ¨æ€ç»˜åˆ¶è¿‡ç¨‹ç”Ÿæˆè§†é¢‘ã€‚

```jsx
import { FFmpeg } from "@ffmpeg/ffmpeg";

const generateVideo = async frames => {
  const ffmpeg = new FFmpeg();
  await ffmpeg.load();

  // ä¸Šä¼ æˆªå›¾
  frames.forEach((frame, index) => {
    ffmpeg.FS("writeFile", `frame${index}.png`, frame);
  });

  // åˆæˆè§†é¢‘
  await ffmpeg.run(
    "-framerate",
    "30",
    "-i",
    "frame%d.png",
    "-pix_fmt",
    "yuv420p",
    "output.mp4"
  );

  const data = ffmpeg.FS("readFile", "output.mp4");
  const videoBlob = new Blob([data.buffer], { type: "video/mp4" });

  // ä¸‹è½½è§†é¢‘
  const link = document.createElement("a");
  link.href = URL.createObjectURL(videoBlob);
  link.download = "track.mp4";
  link.click();
};
```

---

## 4. é‡åˆ°çš„é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 1. **FFmpeg æ€§èƒ½è¾ƒä½**

- **é—®é¢˜**: åœ¨ React ä¸­ä½¿ç”¨ FFmpeg.wasm ç”Ÿæˆè§†é¢‘æ—¶ï¼Œæ€§èƒ½ç“¶é¢ˆéå¸¸æ˜æ˜¾ï¼Œå°¤å…¶æ˜¯å¤„ç†è¾ƒé•¿è½¨è¿¹æ—¶ã€‚
- **è§£å†³æ–¹æ¡ˆ**: è€ƒè™‘å°†é¡¹ç›®è¿ç§»åˆ° Electron ç¯å¢ƒï¼Œç›´æ¥è°ƒç”¨ç³»ç»Ÿå†…ç½®çš„ FFmpeg å‘½ä»¤è¡Œå·¥å…·ï¼Œä»è€Œæå‡æ€§èƒ½ã€‚

### 2. **è½¨è¿¹åŠ¨ç”»ä¸æ—¶é—´æˆ³å¯¹é½é—®é¢˜**

- **é—®é¢˜**: åœ¨åŠ¨æ€ç»˜åˆ¶è½¨è¿¹æ—¶ï¼Œç”±äºæ—¶é—´æˆ³å¤„ç†ä¸å½“ï¼ŒåŠ¨ç”»èŠ‚å¥å¯èƒ½ä¸å®é™…æ—¶é—´ä¸ç¬¦ã€‚
- **è§£å†³æ–¹æ¡ˆ**: é€šè¿‡ GPX æ–‡ä»¶ä¸­çš„æ—¶é—´æˆ³è®¡ç®—æ¯å¸§çš„æŒç»­æ—¶é—´ï¼Œå¹¶åœ¨è§†é¢‘åˆæˆæ—¶ä½¿ç”¨ `-vsync vfr` å‚æ•°æ”¯æŒå˜å¸§ç‡ã€‚

### 3. **FFmpeg è¿›åº¦ç›‘å¬**

- **é—®é¢˜**: åœ¨ FFmpeg è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œéœ€è¦è·å–è§†é¢‘ç”Ÿæˆçš„å®æ—¶è¿›åº¦ã€‚
- **è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ FFmpeg çš„ `on("progress")` ç›‘å¬å™¨ï¼Œæ ¹æ®å¤„ç†çš„å¸§æ•°åŠ¨æ€æ›´æ–°è¿›åº¦æ¡ã€‚

---

## 5. æœ€ç»ˆæ•ˆæœ

ç”¨æˆ·ä¸Šä¼  GPX æ–‡ä»¶åï¼š

1. åœ°å›¾ä¸ŠåŠ¨æ€å±•ç¤ºè½¨è¿¹ã€‚
2. å¯¼å‡ºè½¨è¿¹è§†é¢‘ï¼Œç²¾ç¡®å¯¹é½æ—¶é—´æˆ³ã€‚

---

## 6. æºä»£ç ä¸ç¤ºä¾‹

å®Œæ•´é¡¹ç›®æºç ï¼š[GitHub Repository](#)

è¿è¡Œé¡¹ç›®ï¼š

```bash
npm install
npm run dev
```

---

é€šè¿‡è¿™ç¯‡æ–‡ç« ï¼Œä½ å­¦ä¼šäº†å¦‚ä½•ç»“åˆ Reactã€Mapbox.js å’Œ FFmpeg ç”Ÿæˆ GPX è½¨è¿¹è§†é¢‘ï¼ŒåŒæ—¶ä¹Ÿåˆ†äº«äº†è§£å†³å¼€å‘ä¸­å¸¸è§é—®é¢˜çš„æ–¹æ³•ã€‚å¸Œæœ›è¿™ä¸ªé¡¹ç›®èƒ½ä¸ºä½ çš„ä¸‹ä¸€ä¸ªåˆ›æ„æä¾›çµæ„Ÿï¼ğŸ‰
